<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fuel-Route Planner — Geoapify + EIA + AI Recommendations</title>
  <style>
    :root{ --bg:#0b1120; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#3b82f6; --border:rgba(148,163,184,.18) }
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:linear-gradient(to bottom right, rgba(15,23,42,.92), rgba(2,6,23,.92));border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    input,select,button{font-size:14px}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1320;color:#e5e7eb}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#14213a;color:#e5e7eb;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff}
    .list{display:flex;flex-direction:column;gap:10px}
    .station{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1320}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;background:#1f2937;color:#e5e7eb;border:1px solid var(--border)}
    .small{font-size:12px}
    .muted{color:var(--muted)}
    .ok{background:#0b3320;border:1px solid #22c55e;color:#dcfce7;padding:8px;border-radius:10px}
    .error{background:#2b1515;border:1px solid #7f1d1d;color:#fecaca;padding:8px;border-radius:10px}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .mono{font-variant-numeric:tabular-nums}
    .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}
    .spinner{width:36px;height:36px;border:4px solid rgba(255,255,255,.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="loading" class="loading"><div><div class="spinner" style="margin:auto"></div><div class="small" style="text-align:center;margin-top:10px">Loading…</div></div></div>
  <div class="wrap">
    <header class="card">
      <h1>Fuel‑Route Planner</h1>
      <div class="tools" id="toolbar">
        <label>Provider
          <select id="provider" title="Price provider">
            <option value="none">No prices</option>
            <option value="eia" selected>Attach EIA estimates</option>
          </select>
        </label>
        <label>Chains
          <select id="chainFilter" title="Major vs independent">
            <option value="all" selected>All truck‑friendly</option>
            <option value="major">Major chains only</option>
            <option value="independent">Independent only</option>
          </select>
        </label>
        <label>Sort by
          <select id="sortBy" title="Result ordering">
            <option value="route" selected>Route order</option>
            <option value="distance">Distance from start</option>
            <option value="price">Price (asc)</option>
          </select>
        </label>
        <label>Max detour (mi)
          <input id="detour" type="number" step="0.5" value="5" style="width:120px" />
        </label>
      </div>
    </header>

      <section class="card" style="margin-top:12px">
        <div class="row">
          <label><span class="small muted">Start (exact address OK)</span>
            <input id="start" placeholder="6418 Centennial Blvd, Nashville, TN 37209" list="startList" autocomplete="off" />
            <datalist id="startList"></datalist>
          </label>
          <label><span class="small muted">Destination (exact address OK)</span>
            <input id="destination" placeholder="2594 US‑301, Dunn, NC 28334" list="destinationList" autocomplete="off" />
            <datalist id="destinationList"></datalist>
          </label>
        </div>
        <div class="row" style="margin-top:8px">
          <label><span class="small muted">Fuel level (gal)</span>
            <input id="fuelLevel" type="number" step="0.1" value="40" />
          </label>
        </div>
        <div id="advancedFields" style="display:none;margin-top:8px">
          <div class="row-3">
            <label><span class="small muted">Vehicle load weight (lbs, optional)</span>
              <input id="vehicleLoadWeight" type="number" step="100" placeholder="80000" />
            </label>
            <label><span class="small muted">Governed speed (mph)</span>
              <input id="governedSpeed" type="number" step="1" value="70" />
            </label>
            <label><span class="small muted">Driver cost ($/hr)</span>
              <input id="driverCostPerHour" type="number" step="1" value="122" />
            </label>
          </div>
        </div>
        <input id="mpg" type="hidden" value="8" />
        <input id="tank" type="hidden" value="160" />
        <input id="reserve" type="hidden" value="25" />
        <input id="terrain" type="hidden" value="rolling" />
        <input id="wind" type="hidden" value="0" />
        <div style="margin-top:8px">
          <button id="toggleAdvanced" type="button" class="btn">Show Advanced</button>
        </div>
        <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap;margin-top:8px">
          <button id="planBtn" type="button" class="btn primary">Plan Route</button>
          <button id="resetBtn" type="button" class="btn">Reset</button>
          <span id="alerts" class="small muted"></span>
        </div>
      </section>

    <section class="card" style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:600">Stations near your route (truck‑friendly)</div>
        <div class="small muted">Prices show as “—” unless EIA estimates are enabled.</div>
      </div>
      <div id="stations" class="list small"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <div style="font-weight:600;margin-bottom:6px">AI Recommendation</div>
      <div class="small muted">We adjust MPG for weight/terrain/speed/wind, compute range & reserve, then recommend stops using estimated prices.</div>
      <div class="tools" style="margin-top:8px">
        <button id="recoBtn" type="button" class="btn primary">Compute AI Plan</button>
        <div id="recoSummary" class="small"></div>
      </div>
      <div class="tools" style="margin-top:6px"><label class="small"><input type="checkbox" id="hazmat"/> Hazmat routing</label></div>
      <div id="recoPlan" class="list small" style="margin-top:8px"></div>
    </section>

    <script>
      const $=id=>document.getElementById(id);
      const MI_PER_M=1/1609.344; 
      const GEOAPIFY_KEY='9a30d1fe0c684c489f1ff7f506e9a1ff'; 
      const EIA_KEY='xfGagmkwAlzScExC639DPUctyuWheqZSQPfxErvu';
      function note(kind,msg){ const el=$('alerts'); el.className = 'small '+(kind==='ok'?'ok':kind==='error'?'error':'muted'); el.innerHTML=msg; }

      // Autocomplete (Geoapify)
      let suggestTimer=null;
      function attachAutocomplete(inputId,listId){
        const input=$(inputId), list=$(listId);
        input.addEventListener('input',()=>{
          clearTimeout(suggestTimer);
          const q=input.value.trim();
          if(q.length<3){ list.innerHTML=''; return; }
          suggestTimer=setTimeout(async()=>{
            try{
              const u=new URL('https://api.geoapify.com/v1/geocode/autocomplete');
              u.searchParams.set('text', q);
              u.searchParams.set('limit','8');
              u.searchParams.set('apiKey', GEOAPIFY_KEY);
              const j=await fetch(u.toString()).then(r=>r.json());
              const uniq=[...new Set((j.features||[]).map(f=>f.properties.formatted))];
              list.innerHTML=uniq.map(v=>`<option value="${v}"></option>`).join('');
            }catch{}
          },200);
        });
      }

      // Geocode + routing (Geoapify fallback to OSRM)
      async function geocode(q){
        const u=new URL('https://api.geoapify.com/v1/geocode/search');
        u.searchParams.set('text', q);
        u.searchParams.set('limit','1');
        u.searchParams.set('apiKey', GEOAPIFY_KEY);
        const j=await fetch(u.toString()).then(r=>r.json());
        const f=j.features?.[0];
        if(!f) throw new Error('Location not found: '+q);
        return [f.geometry.coordinates[0], f.geometry.coordinates[1]];
      }
      async function routeOSRM(start,end){
        const url=`https://router.project-osrm.org/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&geometries=geojson`;
        const js=await fetch(url).then(r=>r.json());
        if(js.code!=='Ok') throw new Error('Routing failed');
        return js.routes[0].geometry;
      }
      async function routeGeoapify(start,end){
        const truckHeightM = 4.115, truckWidthM=2.59, truckLengthM=22.86, truckWeightKg=36287;
        const haz = $('hazmat')? $('hazmat').checked:false;
        const u=new URL('https://api.geoapify.com/v1/routing');
        u.searchParams.set('waypoints', `${start[0]},${start[1]}|${end[0]},${end[1]}`);
        u.searchParams.set('mode','drive'); u.searchParams.set('vehicle','truck');
        u.searchParams.set('truckHeight',truckHeightM); u.searchParams.set('truckWidth',truckWidthM);
        u.searchParams.set('truckLength',truckLengthM); u.searchParams.set('truckWeight',truckWeightKg);
        if(haz) u.searchParams.set('hazmat','true');
        u.searchParams.set('details','instruction_details');
        u.searchParams.set('apiKey',GEOAPIFY_KEY);
        const r=await fetch(u.toString());
        if(!r.ok) throw new Error('Geoapify routing error '+r.status);
        const j=await r.json();
        if(!j?.features?.[0]) throw new Error('Geoapify routing: no route returned');
        return j.features[0].geometry;
      }

      // Distance + detour helpers
      function haversine(a,b){ const R=6371000, toRad=d=>d*Math.PI/180;
        const dLat=toRad(b[1]-a[1]), dLon=toRad(b[0]-a[0]), la1=toRad(a[1]), la2=toRad(b[1]);
        const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); }
      function nearestIndexOnRoute(pt,coords){ let best=Infinity,bestIdx=0; for(let i=0;i<coords.length;i+=10){ const d=haversine([coords[i][0],coords[i][1]],[pt.lon,pt.lat]); if(d<best){best=d;bestIdx=i;} } return bestIdx; }
      function pathDist(coords,i0,i1){ let d=0; for(let i=i0;i<i1;i++){ d+=haversine(coords[i],coords[i+1]); } return d; }
      function readDetour(){ const el=$('detour'); return el ? parseFloat(el.value||'5') : 5; }

      // Places (Geoapify)
      async function fetchStationsGeoapify(geo, detourMi, chainFilter){
        const coords=geo.coordinates;
        const major=['Pilot','Flying J','Love\'s','TA','Petro','TA Express','Sapp Bros','Kwik Trip','Kwik Star','Maverik'];
        // split long routes into smaller bounding boxes to avoid API 400 errors
        function splitBoxes(cs, span=2){
          const boxes=[]; let cur=[],minLon,maxLon,minLat,maxLat,sumLat=0;
          for(const [lon,lat] of cs){
            if(cur.length===0){
              cur.push([lon,lat]);
              minLon=maxLon=lon; minLat=maxLat=lat; sumLat=lat;
            }else{
              const nMinLon=Math.min(minLon,lon), nMaxLon=Math.max(maxLon,lon);
              const nMinLat=Math.min(minLat,lat), nMaxLat=Math.max(maxLat,lat);
              if((nMaxLon-nMinLon)>span || (nMaxLat-nMinLat)>span){
                boxes.push({minLon,maxLon,minLat,maxLat,meanLat:sumLat/cur.length});
                cur=[[lon,lat]];
                minLon=maxLon=lon; minLat=maxLat=lat; sumLat=lat;
              }else{
                cur.push([lon,lat]);
                minLon=nMinLon; maxLon=nMaxLon; minLat=nMinLat; maxLat=nMaxLat; sumLat+=lat;
              }
            }
          }
          if(cur.length) boxes.push({minLon,maxLon,minLat,maxLat,meanLat:sumLat/cur.length});
          return boxes;
        }
        const boxes=splitBoxes(coords);
        const feats=[];
        for(const b of boxes){
          const degPerMiLat=1/69.0, degPerMiLon=1/(69.172*Math.cos(b.meanLat*Math.PI/180));
          const padLon=Math.max(detourMi,5)*degPerMiLon, padLat=Math.max(detourMi,5)*degPerMiLat;
          const url=new URL('https://api.geoapify.com/v2/places');
          url.searchParams.set('categories','service.vehicle.fuel,transport.truck_stop');
          url.searchParams.set('filter',`rect:${b.minLon-padLon},${b.minLat-padLat},${b.maxLon+padLon},${b.maxLat+padLat}`);
          url.searchParams.set('limit','500');
          url.searchParams.set('apiKey',GEOAPIFY_KEY);
          const r=await fetch(url.toString());
          if(!r.ok) throw new Error('Places error '+r.status);
          const j=await r.json();
          feats.push(...(j.features||[]));
        }
        const seen=new Set();
        let list=feats.map(f=>({
          id:f.properties.place_id || f.properties.datasource?.raw?.id || f.properties.osm_id || Math.random(),
          name:f.properties.name || 'Fuel Station',
          brand:f.properties.brand || f.properties.operator || '',
          lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0],
          addr:[f.properties.housenumber,f.properties.street,f.properties.city,f.properties.state].filter(Boolean).join(', '),
          state:(f.properties.state_code || f.properties.state || '').toString().toUpperCase().replace('US-',''),
          truckFriendly:true, dieselPrice:null, dieselPrice_note:null
        })).filter(s=>{ if(seen.has(s.id)) return false; seen.add(s.id); return true; });
        if(chainFilter==='major') list=list.filter(s=>major.some(m=>(s.brand||'').toLowerCase().includes(m.toLowerCase())));
        if(chainFilter==='independent') list=list.filter(s=>!major.some(m=>(s.brand||'').toLowerCase().includes(m.toLowerCase())));
        return list;
      }

      // EIA prices (state → PADD → US)
      const STATE_TO_PADD={ CT:'R1A',ME:'R1A',MA:'R1A',NH:'R1A',RI:'R1A',VT:'R1A', DE:'R1B',DC:'R1B',MD:'R1B',NJ:'R1B',NY:'R1B',PA:'R1B', FL:'R1C',GA:'R1C',NC:'R1C',SC:'R1C',VA:'R1C',WV:'R1C', IL:'R20',IN:'R20',IA:'R20',KS:'R20',KY:'R20',MI:'R20',MN:'R20',MO:'R20',NE:'R20',ND:'R20',OH:'R20',OK:'R20',SD:'R20',TN:'R20',WI:'R20', AL:'R30',AR:'R30',LA:'R30',MS:'R30',NM:'R30',TX:'R30', CO:'R40',ID:'R40',MT:'R40',UT:'R40',WY:'R40', AK:'R50',AZ:'R50',CA:'R50',HI:'R50',NV:'R50',OR:'R50',WA:'R50' };
      async function eiaLatest(area, product='EPD2D', series){ const s = series|| (area.startsWith('R')||area==='NUS' ? 'dpr' : 'gnd');
        const url=`https://api.eia.gov/v2/petroleum/pri/${s}/data/?api_key=${EIA_KEY}&frequency=weekly&data[0]=value&facets[product][]=${product}&facets[area][]=${area}&sort[0][column]=period&sort[0][direction]=desc&offset=0&length=1`;
        const r=await fetch(url); if(!r.ok) throw new Error('EIA '+r.status); const j=await r.json(); return j?.response?.data?.[0]?.value ?? null; }
      async function enrichWithEIA(stations){
        const groups={}; stations.forEach(s=>{ const st=s.state||''; (groups[st] ||= []).push(s); });
        const cache=new Map();
        async function getAreaPrice(st){
          if(cache.has(st)) return cache.get(st); let v=null, note=null;
          if(st){ try{ v=await eiaLatest(st,'EPD2D','gnd'); note='EIA state avg.'; }catch{} }
          if(v==null){ const padd=STATE_TO_PADD[st]||null; if(padd){ try{ v=await eiaLatest(padd,'EPD2D','dpr'); note='EIA PADD avg.'; }catch{} } }
          if(v==null){ try{ v=await eiaLatest('NUS','EPD2D','gnd'); note='EIA U.S. avg.'; }catch{} }
          const out = v!=null?{v,note}:{v:3.95,note:'EIA U.S. avg. (fallback)'}; cache.set(st,out); return out;
        }
        for(const [st,arr] of Object.entries(groups)){ const res=await getAreaPrice(st); arr.forEach(s=>{ s.dieselPrice=res.v; s.dieselPrice_note=res.note; }); }
        return stations;
      }

      // Vehicle + AI planner
      function readVehicle(){
          const tank=parseFloat($('tank').value||'160');
          let fuel=parseFloat($('fuelLevel').value||'0');
          const reserve=parseFloat($('reserve').value||'0');
          const mpgBase=parseFloat($('mpg').value||'8');
          const weight=parseFloat($('vehicleLoadWeight').value||'80000');
          const terrain=$('terrain').value||'rolling';
          const govSpeed=parseFloat($('governedSpeed').value||'70');
          const wind=parseFloat($('wind').value||'0');
          const driverCost=parseFloat($('driverCostPerHour').value||'122');
        const terrainFactor = {flat:1.00, rolling:0.95, hilly:0.90, mountain:0.80}[terrain]||0.95;
        const weightFactor = Math.max(0.7, 1 - Math.max(0, (weight-60000))/10000*0.03);
        const speedFactor = Math.max(0.7, 1 - Math.max(0, (govSpeed-60))/5*0.02);
        const windFactor = Math.max(0.75, 1 - Math.max(0, wind)*0.004);
        const mpgEff = mpgBase * terrainFactor * weightFactor * speedFactor * windFactor;
        return {tank,fuel,reserve,mpgBase,mpgEff,govSpeed,driverCost};
      }
      function aiRecommend(routeGeo, stations){
        const {tank,fuel,reserve,mpgEff}=readVehicle();
        const coords=routeGeo.coordinates;
        const withMiles = stations.map(s=>{ const idx=nearestIndexOnRoute({lat:s.lat,lon:s.lon},coords); const m=pathDist(coords,0,idx)*MI_PER_M; return {...s, milesFromStart:m}; }).sort((a,b)=>a.milesFromStart-b.milesFromStart);
        const totalMiles = pathDist(coords,0,coords.length-1)*MI_PER_M;
        const maxRange = tank*mpgEff;
        let posMiles = 0, fuelGal = fuel;
        const plan=[];
        function chooseNext(pos, range){
          const reachable = withMiles.filter(s=> s.milesFromStart>pos && s.milesFromStart <= pos + range - reserve + 1e-6);
          if(reachable.length===0) return null;
          return reachable.reduce((best,cur)=> ((cur.dieselPrice??Infinity) < (best?.dieselPrice??Infinity)) ? cur : best, null);
        }
        function needBeforeStart(){
          const canReach = chooseNext(0, fuelGal*mpgEff);
          if(!canReach){
            const needMiles = Math.max(0, (withMiles[0]?.milesFromStart||totalMiles) + reserve - fuelGal*mpgEff);
            const needGal = needMiles/mpgEff;
            plan.push({type:'prestart', action:`Buy ${needGal.toFixed(1)} gal before departure to reach first stop.`});
            fuelGal += needGal;
          }
        }
        needBeforeStart();
        while(posMiles < totalMiles - 1){
          const curRange = fuelGal*mpgEff;
          if(posMiles + curRange >= totalMiles){
            plan.push({type:'finish', action:`You can finish the trip without refueling. Remaining fuel at arrival ≈ ${((curRange-(totalMiles-posMiles))/mpgEff).toFixed(1)} gal.`});
            break;
          }
          const target = chooseNext(posMiles, curRange);
          if(!target){
            const needMore = ((withMiles.find(s=>s.milesFromStart>posMiles)?.milesFromStart||totalMiles) + reserve - (posMiles+curRange))/mpgEff;
            plan.push({type:'gap', action:`Insufficient range window; increase starting fuel by ${needMore.toFixed(1)} gal or reduce reserve.`});
            break;
          }
          const milesTo = target.milesFromStart - posMiles;
          fuelGal = Math.max(0, fuelGal - milesTo/mpgEff);
          posMiles = target.milesFromStart;
          const nextCheaper = withMiles.find(s=> s.milesFromStart>posMiles && (s.dieselPrice??Infinity) < (target.dieselPrice??Infinity) && (s.milesFromStart - posMiles) <= maxRange - reserve);
          let buyGal;
          if(nextCheaper){
            const needMiles = nextCheaper.milesFromStart - posMiles + reserve;
            const needGal = Math.max(0, needMiles/mpgEff - fuelGal);
            buyGal = Math.min( tank - fuelGal, needGal );
          }else{
            const remMiles = totalMiles - posMiles + reserve;
            const needGal = Math.max(0, remMiles/mpgEff - fuelGal);
            buyGal = Math.min( tank - fuelGal, needGal );
          }
          const estPrice = target.dieselPrice ?? null;
          const estCost = estPrice!=null ? buyGal*estPrice : null;
          plan.push({type:'stop', station:target, gallons:buyGal, cost:estCost});
          fuelGal += buyGal;
        }
        return {plan, mpgEff, maxRange, totalMiles};
      }
      function renderPlan(out){
        const box=$('recoPlan'); box.innerHTML='';
        const sum=$('recoSummary');
        sum.innerHTML = `<div class="kvs"><div>Effective MPG</div><div class="mono">${out.mpgEff.toFixed(2)}</div><div>Max range (full tank)</div><div class="mono">${out.maxRange.toFixed(0)} mi</div><div>Total route</div><div class="mono">${out.totalMiles.toFixed(0)} mi</div></div>`;
        if(out.plan.length===0){ box.innerHTML='<div class="muted">No actions needed.</div>'; return; }
        out.plan.forEach(step=>{
          const row=document.createElement('div'); row.className='station';
          if(step.type==='stop'){
            row.innerHTML=`<div><b>Stop at:</b> ${step.station.name} <span class="muted">(${step.station.addr||'coords'})</span>
              <div>Buy <b>${step.gallons.toFixed(1)} gal</b>${step.cost!=null?` @ ~$${(step.station.dieselPrice).toFixed(3)}/gal ≈ <b>$${step.cost.toFixed(2)}</b>`:''}</div>
              <div class="muted">Milepost: ${step.station.milesFromStart.toFixed(1)} · Price source: ${step.station.dieselPrice_note||'—'}</div>
            </div>`;
          }else{
            row.innerHTML=`<div>${step.action}</div>`;
          }
          box.appendChild(row);
        });
      }

      // Stations UI
      function renderStations(routeGeo, stations){
        const sort = $('sortBy').value;
        const coords=routeGeo.coordinates;
        const annotated = stations.map(s=>{ const idx=nearestIndexOnRoute({lat:s.lat,lon:s.lon},coords); const milesFromStart=pathDist(coords,0,idx)*MI_PER_M; return {...s, idx, milesFromStart}; });
        let items = annotated;
        if(sort==='distance') items = annotated.slice().sort((a,b)=>a.milesFromStart-b.milesFromStart);
        else if(sort==='price') items = annotated.slice().sort((a,b)=> (a.dieselPrice??Infinity)-(b.dieselPrice??Infinity));
        else items = annotated.slice().sort((a,b)=>a.idx-b.idx);
        const host=$('stations'); host.innerHTML='';
        if(items.length===0){ host.innerHTML='<div class="muted">No stations found within your detour/filters for this route. Try widening detour or allowing all chains.</div>'; return; }
        items.forEach(s=>{
          const maps=`https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lon}`;
          const priceStr = s.dieselPrice!=null? `$${s.dieselPrice.toFixed(3)}/gal` : '—';
          const note = s.dieselPrice_note? ` <span class="muted">(${s.dieselPrice_note})</span>`:'';
          const major=['Pilot','Flying J','Love\'s','TA','Petro','TA Express','Sapp Bros','Kwik Trip','Kwik Star','Maverik'];
          const chainType=major.some(m=>(s.brand||'').toLowerCase().includes(m.toLowerCase()))?'Major':'Independent';
          const row=document.createElement('div'); row.className='station';
          row.innerHTML=`<div><b>${s.name}</b><div class="muted">${s.addr||''}</div>
            <div style="margin-top:4px">Brand: <span class="badge">${s.brand||'—'}</span> · Chain: <span class="badge">${chainType}</span></div>
            <div style="margin-top:4px">Diesel: <b>${priceStr}</b>${note}</div>
            <div style="margin-top:4px">Distance from start: <b>${s.milesFromStart.toFixed(1)} mi</b></div>
            <div style="margin-top:4px"><a href="${maps}" target="_blank">Open in Maps</a></div>
          </div>`;
          host.appendChild(row);
        });
      }

      // Plan handler
      async function plan(){
        try{
          $('loading').style.display='flex';
          note('','');
            const startQ=$('start').value.trim(); const destQ=$('destination').value.trim();
            if(!startQ||!destQ){ note('error','Please enter both <b>Start</b> and <b>Destination</b>.'); return; }
            const [a,b]=await Promise.all([geocode(startQ), geocode(destQ)]);
          let geo=null;
          try { geo = await routeGeoapify(a,b); } catch(_) { geo = await routeOSRM(a,b); }
          const detour = readDetour();
          const chain  = $('chainFilter').value;
          const provider = $('provider').value;

          let stns = await fetchStationsGeoapify(geo, detour, chain);
          if(provider==='eia'){
            try{ stns = await enrichWithEIA(stns); }catch(e){ stns.forEach(s=>{ if(s.dieselPrice==null){ s.dieselPrice=3.95; s.dieselPrice_note='EIA U.S. avg. (fallback)'; } }); }
          }

          renderStations(geo, stns);
          note('ok','Route and stations loaded.');

          $('recoBtn').onclick=()=>{ const out=aiRecommend(geo, stns); renderPlan(out); };
        }catch(e){
          note('error', e.message);
        }finally{
          $('loading').style.display='none';
        }
      }

      // Wire up UI
        $('planBtn').onclick=async()=>{ const btn=$('planBtn'); btn.disabled=true; btn.textContent='Planning…'; try{ await plan(); } finally { btn.disabled=false; btn.textContent='Plan Route'; } };
        $('resetBtn').onclick=()=>location.reload();
        $('sortBy').onchange=plan; $('chainFilter').onchange=plan; $('provider').onchange=plan;
        $('toggleAdvanced').onclick=()=>{ const adv=$('advancedFields'); const show=adv.style.display!=='none'; adv.style.display=show?'none':'block'; $('toggleAdvanced').textContent=show?'Show Advanced':'Hide Advanced'; };
        attachAutocomplete('start','startList'); attachAutocomplete('destination','destinationList');
    </script>
  </div>
</body>
</html>
