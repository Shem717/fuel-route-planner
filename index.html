<!doctype html> (no “```” or YAML front matter ---).<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2685.1">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
  </style>
</head>
<body>
<p class="p1">&lt;!doctype html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta charset="utf-8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;title&gt;Fuel-Route Planner — Geoapify Places + EIA Estimates + AI Recommendations&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>:root{ --bg:#0b1120; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --accent:#3b82f6; --border:rgba(148,163,184,.18) }</p>
<p class="p1"><span class="Apple-converted-space">    </span>body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.wrap{max-width:1200px;margin:0 auto;padding:20px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.card{background:linear-gradient(to bottom right, rgba(15,23,42,.92), rgba(2,6,23,.92));border:1px solid var(--border);border-radius:16px;padding:14px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>input,select,button{font-size:14px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1320;color:#e5e7eb}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#14213a;color:#e5e7eb;cursor:pointer}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.btn.primary{background:var(--accent);color:#fff}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.list{display:flex;flex-direction:column;gap:10px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.station{display:flex;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1320}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.badge{font-size:11px;padding:2px 8px;border-radius:999px;background:#1f2937;color:#e5e7eb;border:1px solid var(--border)}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.small{font-size:12px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.muted{color:var(--muted)}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.hr{height:1px;background:var(--border);margin:10px 0}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.ok{background:#0b3320;border:1px solid #22c55e;color:#dcfce7;padding:8px;border-radius:10px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.error{background:#2b1515;border:1px solid #7f1d1d;color:#fecaca;padding:8px;border-radius:10px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.kvs{display:grid;grid-template-columns:1fr 1fr;gap:6px}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.mono{font-variant-numeric:tabular-nums}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}</p>
<p class="p1"><span class="Apple-converted-space">    </span>.spinner{width:36px;height:36px;border:4px solid rgba(255,255,255,.3);border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}</p>
<p class="p1"><span class="Apple-converted-space">    </span>@keyframes spin{to{transform:rotate(360deg)}}</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="loading" class="loading"&gt;&lt;div&gt;&lt;div class="spinner" style="margin:auto"&gt;&lt;/div&gt;&lt;div class="small" style="text-align:center;margin-top:10px"&gt;Loading…&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div class="wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;header class="card"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;h1&gt;Fuel‑Route Planner&lt;/h1&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="tools" id="toolbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;Provider</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;select id="provider" title="Price provider"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="none"&gt;No prices&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="eia" selected&gt;Attach EIA estimates&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;Chains</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;select id="chainFilter" title="Major vs independent"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="all" selected&gt;All truck‑friendly&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="major"&gt;Major chains only&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="independent"&gt;Independent only&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;Sort by</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;select id="sortBy" title="Result ordering"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="route" selected&gt;Route order&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="distance"&gt;Distance from start&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;option value="price"&gt;Price (asc)&lt;/option&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;Max detour (mi)</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="detour" type="number" step="0.5" value="5" style="width:120px" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/header&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;section class="card" style="margin-top:12px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Start (exact address OK)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="start" placeholder="6418 Centennial Blvd, Nashville, TN 37209" list="startList" autocomplete="off" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;datalist id="startList"&gt;&lt;/datalist&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Destination (exact address OK)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="end" placeholder="2594 US‑301, Dunn, NC 28334" list="endList" autocomplete="off" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;datalist id="endList"&gt;&lt;/datalist&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row-3" style="margin-top:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Base MPG&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="mpg" type="number" step="0.1" value="8" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Tank size (gal)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="tank" type="number" step="1" value="160" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Current fuel&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;div class="row" style="grid-template-columns:2fr 1fr"&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;input id="fuelVal" type="number" step="0.1" value="40" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;select id="fuelUnit"&gt;&lt;option value="gal"&gt;gal&lt;/option&gt;&lt;option value="pct"&gt;% of tank&lt;/option&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row-3" style="margin-top:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Reserve buffer (miles)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="reserve" type="number" step="1" value="25" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Gross weight (lbs, optional)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="weight" type="number" step="100" placeholder="80000" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Terrain&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;select id="terrain"&gt;&lt;option value="flat"&gt;Flat&lt;/option&gt;&lt;option value="rolling" selected&gt;Rolling&lt;/option&gt;&lt;option value="hilly"&gt;Hilly&lt;/option&gt;&lt;option value="mountain"&gt;Mountain&lt;/option&gt;&lt;/select&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="row-3" style="margin-top:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Governed speed (mph)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="govSpeed" type="number" step="1" value="70" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Headwind (mph, optional)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="wind" type="number" step="1" placeholder="0" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;label&gt;&lt;span class="small muted"&gt;Driver cost ($/hr)&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;input id="driverCost" type="number" step="1" value="122" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/label&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;button id="planBtn" type="button" class="btn primary"&gt;Plan Route&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;button id="resetBtn" type="button" class="btn"&gt;Reset&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;span id="alerts" class="small muted"&gt;&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/section&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;section class="card" style="margin-top:14px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div style="font-weight:600"&gt;Stations near your route (truck‑friendly)&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div class="small muted"&gt;Prices show as “—” unless EIA estimates are enabled.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="stations" class="list small"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/section&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;section class="card" style="margin-top:14px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div style="font-weight:600;margin-bottom:6px"&gt;AI Recommendation&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="small muted"&gt;We adjust MPG for weight/terrain/speed/wind, compute range &amp; reserve, then recommend stops using estimated prices.&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="tools" style="margin-top:8px"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;button id="recoBtn" type="button" class="btn primary"&gt;Compute AI Plan&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;div id="recoSummary" class="small"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div class="tools" style="margin-top:6px"&gt;&lt;label class="small"&gt;&lt;input type="checkbox" id="hazmat"/&gt; Hazmat routing&lt;/label&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;div id="recoPlan" class="list small" style="margin-top:8px"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/section&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Constants &amp; utils ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>const $ = id =&gt; document.getElementById(id);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const MI_PER_M = 1/1609.344;</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Hard-coded API keys (per your request)</p>
<p class="p1"><span class="Apple-converted-space">      </span>const GEOAPIFY_KEY = '9a30d1fe0c684c489f1f7f506e9a1ff';</p>
<p class="p1"><span class="Apple-converted-space">      </span>const EIA_KEY<span class="Apple-converted-space">      </span>= 'xfGagmkwAlzScExC639DPUctyuWheqZSQPfxErvu';</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>function note(kind,msg){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const el=$('alerts');</p>
<p class="p1"><span class="Apple-converted-space">        </span>el.className = 'small '+(kind==='ok'?'ok':kind==='error'?'error':'muted');</p>
<p class="p1"><span class="Apple-converted-space">        </span>el.innerHTML = msg;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Autocomplete via Nominatim (no key) ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>let suggestTimer=null;</p>
<p class="p1"><span class="Apple-converted-space">      </span>function attachAutocomplete(inputId,listId){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const input=$(inputId), list=$(listId);</p>
<p class="p1"><span class="Apple-converted-space">        </span>input.addEventListener('input',()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">          </span>clearTimeout(suggestTimer);</p>
<p class="p1"><span class="Apple-converted-space">          </span>const q=input.value.trim();</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(q.length&lt;3){ list.innerHTML=''; return; }</p>
<p class="p1"><span class="Apple-converted-space">          </span>suggestTimer=setTimeout(async()=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">            </span>try{</p>
<p class="p1"><span class="Apple-converted-space">              </span>const url=`https://nominatim.openstreetmap.org/search?format=json&amp;addressdetails=1&amp;limit=8&amp;q=${encodeURIComponent(q)}`;</p>
<p class="p1"><span class="Apple-converted-space">              </span>const js=await fetch(url,{headers:{'Accept-Language':'en'}}).then(r=&gt;r.json());</p>
<p class="p1"><span class="Apple-converted-space">              </span>const uniq=[...new Set(js.map(r=&gt;r.display_name))];</p>
<p class="p1"><span class="Apple-converted-space">              </span>list.innerHTML=uniq.map(v=&gt;`&lt;option value="${v}"&gt;&lt;/option&gt;`).join('');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}catch{}</p>
<p class="p1"><span class="Apple-converted-space">          </span>},200);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Geocode + Routing ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>async function geocode(q){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const url=`https://nominatim.openstreetmap.org/search?format=json&amp;q=${encodeURIComponent(q)}&amp;limit=1`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const js=await fetch(url,{headers:{'Accept-Language':'en'}}).then(r=&gt;r.json());</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!js[0]) throw new Error('Location not found: '+q);</p>
<p class="p1"><span class="Apple-converted-space">        </span>return [parseFloat(js[0].lon), parseFloat(js[0].lat)];</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>async function routeOSRM(start,end){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const url=`https://router.project-osrm.org/route/v1/driving/${start[0]},${start[1]};${end[0]},${end[1]}?overview=full&amp;geometries=geojson`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const js=await fetch(url).then(r=&gt;r.json());</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(js.code!=='Ok') throw new Error('Routing failed');</p>
<p class="p1"><span class="Apple-converted-space">        </span>return js.routes[0].geometry;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>async function routeGeoapify(start,end){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const truckHeightM = 4.115, truckWidthM=2.59, truckLengthM=22.86, truckWeightKg=36287;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const haz = $('hazmat')? $('hazmat').checked:false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const u=new URL('https://api.geoapify.com/v1/routing');</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('waypoints', `${start[0]},${start[1]}|${end[0]},${end[1]}`);</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('mode','drive');</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('vehicle','truck');</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('truckHeight',truckHeightM);</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('truckWidth',truckWidthM);</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('truckLength',truckLengthM);</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('truckWeight',truckWeightKg);</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(haz) u.searchParams.set('hazmat','true');</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('details','instruction_details');</p>
<p class="p1"><span class="Apple-converted-space">        </span>u.searchParams.set('apiKey',GEOAPIFY_KEY);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const r=await fetch(u.toString());</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!r.ok) throw new Error('Geoapify routing error '+r.status);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const j=await r.json();</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!j?.features?.[0]) throw new Error('Geoapify routing: no route returned');</p>
<p class="p1"><span class="Apple-converted-space">        </span>return j.features[0].geometry;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Distance helpers ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>function haversine(a,b){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const R=6371000; const toRad=d=&gt;d*Math.PI/180;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const dLat=toRad(b[1]-a[1]); const dLon=toRad(b[0]-a[0]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const la1=toRad(a[1]); const la2=toRad(b[1]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const h=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;</p>
<p class="p1"><span class="Apple-converted-space">        </span>return 2*R*Math.asin(Math.sqrt(h));</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>function nearestIndexOnRoute(pt,coords){</p>
<p class="p1"><span class="Apple-converted-space">        </span>let best=Infinity,bestIdx=0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>for(let i=0;i&lt;coords.length;i+=10){</p>
<p class="p1"><span class="Apple-converted-space">          </span>const d=haversine([coords[i][0],coords[i][1]],[pt.lon,pt.lat]);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(d&lt;best){best=d;bestIdx=i;}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>return bestIdx;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>function pathDist(coords,i0,i1){</p>
<p class="p1"><span class="Apple-converted-space">        </span>let d=0; for(let i=i0;i&lt;i1;i++){ d+=haversine(coords[i],coords[i+1]); } return d;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>function readDetour(){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const el=$('detour'); return el ? parseFloat(el.value||'5') : 5;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Places (Geoapify) ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>async function fetchStationsGeoapify(geo, detourMi, chainFilter){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coords=geo.coordinates;</p>
<p class="p1"><span class="Apple-converted-space">        </span>// bbox around route with latitude-aware padding</p>
<p class="p1"><span class="Apple-converted-space">        </span>let minLon=Infinity,maxLon=-Infinity,minLat=Infinity,maxLat=-Infinity, sumLat=0, n=0;</p>
<p class="p1"><span class="Apple-converted-space">        </span>for(const [lon,lat] of coords){ minLon=Math.min(minLon,lon); maxLon=Math.max(maxLon,lon); minLat=Math.min(minLat,lat); maxLat=Math.max(maxLat,lat); sumLat+=lat; n++; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>const meanLat = sumLat/n; const degPerMiLat = 1/69.0; const degPerMiLon = 1/(69.172*Math.cos(meanLat*Math.PI/180));</p>
<p class="p1"><span class="Apple-converted-space">        </span>const padLon = Math.max(detourMi,5)*degPerMiLon; // ensure at least modest padding</p>
<p class="p1"><span class="Apple-converted-space">        </span>const padLat = Math.max(detourMi,5)*degPerMiLat;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const bbox = { minLon: minLon-padLon, minLat: minLat-padLat, maxLon: maxLon+padLon, maxLat: maxLat+padLat };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const major=['Pilot','Flying J','Love\'s','TA','Petro','TA Express','Sapp Bros','Kwik Trip','Kwik Star','Maverik'];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const url = new URL('https://api.geoapify.com/v2/places');</p>
<p class="p1"><span class="Apple-converted-space">        </span>url.searchParams.set('categories','service.vehicle.fuel,transport.truck_stop');</p>
<p class="p1"><span class="Apple-converted-space">        </span>url.searchParams.set('filter',`rect:${bbox.minLon},${bbox.minLat},${bbox.maxLon},${bbox.maxLat}`);</p>
<p class="p1"><span class="Apple-converted-space">        </span>url.searchParams.set('limit','500');</p>
<p class="p1"><span class="Apple-converted-space">        </span>url.searchParams.set('apiKey', GEOAPIFY_KEY);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const r = await fetch(url.toString());</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(!r.ok) throw new Error('Places error '+r.status);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const j = await r.json();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>let list = (j.features||[]).map(f=&gt;({</p>
<p class="p1"><span class="Apple-converted-space">          </span>id: f.properties.place_id || f.properties.datasource?.raw?.id || f.properties.osm_id || Math.random(),</p>
<p class="p1"><span class="Apple-converted-space">          </span>name: f.properties.name || 'Fuel Station',</p>
<p class="p1"><span class="Apple-converted-space">          </span>brand: f.properties.brand || f.properties.operator || '',</p>
<p class="p1"><span class="Apple-converted-space">          </span>lat: f.geometry.coordinates[1],</p>
<p class="p1"><span class="Apple-converted-space">          </span>lon: f.geometry.coordinates[0],</p>
<p class="p1"><span class="Apple-converted-space">          </span>addr: [f.properties.housenumber,f.properties.street,f.properties.city,f.properties.state].filter(Boolean).join(', '),</p>
<p class="p1"><span class="Apple-converted-space">          </span>state: (f.properties.state_code || f.properties.state || '').toString().toUpperCase().replace('US-',''),</p>
<p class="p1"><span class="Apple-converted-space">          </span>truckFriendly: true,</p>
<p class="p1"><span class="Apple-converted-space">          </span>dieselPrice:null, dieselPrice_note:null</p>
<p class="p1"><span class="Apple-converted-space">        </span>}));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>if(chainFilter==='major') list = list.filter(s=&gt; major.some(m=&gt; (s.brand||'').toLowerCase().includes(m.toLowerCase())));</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(chainFilter==='independent') list = list.filter(s=&gt; !major.some(m=&gt; (s.brand||'').toLowerCase().includes(m.toLowerCase())));</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>return list;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- EIA prices: state → PADD → US ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>const STATE_TO_PADD={ CT:'R1A',ME:'R1A',MA:'R1A',NH:'R1A',RI:'R1A',VT:'R1A', DE:'R1B',DC:'R1B',MD:'R1B',NJ:'R1B',NY:'R1B',PA:'R1B', FL:'R1C',GA:'R1C',NC:'R1C',SC:'R1C',VA:'R1C',WV:'R1C', IL:'R20',IN:'R20',IA:'R20',KS:'R20',KY:'R20',MI:'R20',MN:'R20',MO:'R20',NE:'R20',ND:'R20',OH:'R20',OK:'R20',SD:'R20',TN:'R20',WI:'R20', AL:'R30',AR:'R30',LA:'R30',MS:'R30',NM:'R30',TX:'R30', CO:'R40',ID:'R40',MT:'R40',UT:'R40',WY:'R40', AK:'R50',AZ:'R50',CA:'R50',HI:'R50',NV:'R50',OR:'R50',WA:'R50' };</p>
<p class="p1"><span class="Apple-converted-space">      </span>async function eiaLatest(area, product='EPD2D', series){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const s = series|| (area.startsWith('R')||area==='NUS' ? 'dpr' : 'gnd');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const url=`https://api.eia.gov/v2/petroleum/pri/${s}/data/?api_key=${EIA_KEY}&amp;frequency=weekly&amp;data[0]=value&amp;facets[product][]=${product}&amp;facets[area][]=${area}&amp;sort[0][column]=period&amp;sort[0][direction]=desc&amp;offset=0&amp;length=1`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const r=await fetch(url); if(!r.ok) throw new Error('EIA '+r.status); const j=await r.json(); return j?.response?.data?.[0]?.value ?? null;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>async function enrichWithEIA(stations){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const groups={}; stations.forEach(s=&gt;{ const st=s.state||''; (groups[st] ||= []).push(s); });</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cache=new Map();</p>
<p class="p1"><span class="Apple-converted-space">        </span>async function getAreaPrice(st){</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(cache.has(st)) return cache.get(st);</p>
<p class="p1"><span class="Apple-converted-space">          </span>let v=null, note=null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(st){ try{ v=await eiaLatest(st,'EPD2D','gnd'); note='EIA state avg.'; }catch{} }</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(v==null){ const padd=STATE_TO_PADD[st]||null; if(padd){ try{ v=await eiaLatest(padd,'EPD2D','dpr'); note='EIA PADD avg.'; }catch{} } }</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(v==null){ try{ v=await eiaLatest('NUS','EPD2D','gnd'); note='EIA U.S. avg.'; }catch{} }</p>
<p class="p1"><span class="Apple-converted-space">          </span>const out = v!=null?{v,note}:{v:3.95,note:'EIA U.S. avg. (fallback)'}; // never blank</p>
<p class="p1"><span class="Apple-converted-space">          </span>cache.set(st,out); return out;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>for(const [st,arr] of Object.entries(groups)){</p>
<p class="p1"><span class="Apple-converted-space">          </span>const res=await getAreaPrice(st);</p>
<p class="p1"><span class="Apple-converted-space">          </span>arr.forEach(s=&gt;{ s.dieselPrice=res.v; s.dieselPrice_note=res.note; });</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>return stations;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Vehicle &amp; AI planner ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>function readVehicle(){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const tank=parseFloat($('tank').value||'160');</p>
<p class="p1"><span class="Apple-converted-space">        </span>let fuel=parseFloat($('fuelVal').value||'0');</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(($('fuelUnit').value||'gal')==='pct') fuel = tank*(fuel/100);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const reserve=parseFloat($('reserve').value||'0');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const mpgBase=parseFloat($('mpg').value||'8');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const weight=parseFloat($('weight').value||'80000');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const terrain=$('terrain').value||'rolling';</p>
<p class="p1"><span class="Apple-converted-space">        </span>const govSpeed=parseFloat($('govSpeed').value||'70');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const wind=parseFloat($('wind').value||'0');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const driverCost=parseFloat($('driverCost').value||'122');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const terrainFactor = {flat:1.00, rolling:0.95, hilly:0.90, mountain:0.80}[terrain]||0.95;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const weightFactor = Math.max(0.7, 1 - Math.max(0, (weight-60000))/10000*0.03);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const speedFactor = Math.max(0.7, 1 - Math.max(0, (govSpeed-60))/5*0.02);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const windFactor = Math.max(0.75, 1 - Math.max(0, wind)*0.004);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const mpgEff = mpgBase * terrainFactor * weightFactor * speedFactor * windFactor;</p>
<p class="p1"><span class="Apple-converted-space">        </span>return {tank,fuel,reserve,mpgBase,mpgEff,govSpeed,driverCost};</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>function aiRecommend(routeGeo, stations){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const {tank,fuel,reserve,mpgEff}=readVehicle();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coords=routeGeo.coordinates;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const withMiles = stations.map(s=&gt;{ const idx=nearestIndexOnRoute({lat:s.lat,lon:s.lon},coords); const m=pathDist(coords,0,idx)*MI_PER_M; return {...s, milesFromStart:m}; }).sort((a,b)=&gt;a.milesFromStart-b.milesFromStart);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const totalMiles = pathDist(coords,0,coords.length-1)*MI_PER_M;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const maxRange = tank*mpgEff;</p>
<p class="p1"><span class="Apple-converted-space">        </span>let posMiles = 0, fuelGal = fuel;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const plan=[];</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>function chooseNext(pos, range){</p>
<p class="p1"><span class="Apple-converted-space">          </span>const reachable = withMiles.filter(s=&gt; s.milesFromStart&gt;pos &amp;&amp; s.milesFromStart &lt;= pos + range - reserve + 1e-6);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(reachable.length===0) return null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>return reachable.reduce((best,cur)=&gt; ((cur.dieselPrice??Infinity) &lt; (best?.dieselPrice??Infinity)) ? cur : best, null);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>function needBeforeStart(){</p>
<p class="p1"><span class="Apple-converted-space">          </span>const canReach = chooseNext(0, fuelGal*mpgEff);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(!canReach){</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needMiles = Math.max(0, (withMiles[0]?.milesFromStart||totalMiles) + reserve - fuelGal*mpgEff);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needGal = needMiles/mpgEff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>plan.push({type:'prestart', action:`Buy ${needGal.toFixed(1)} gal before departure to reach first stop.`});</p>
<p class="p1"><span class="Apple-converted-space">            </span>fuelGal += needGal;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>needBeforeStart();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>while(posMiles &lt; totalMiles - 1){</p>
<p class="p1"><span class="Apple-converted-space">          </span>const curRange = fuelGal*mpgEff;</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(posMiles + curRange &gt;= totalMiles){</p>
<p class="p1"><span class="Apple-converted-space">            </span>plan.push({type:'finish', action:`You can finish the trip without refueling. Remaining fuel at arrival ≈ ${((curRange-(totalMiles-posMiles))/mpgEff).toFixed(1)} gal.`});</p>
<p class="p1"><span class="Apple-converted-space">            </span>break;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>const target = chooseNext(posMiles, curRange);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(!target){</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needMore = ((withMiles.find(s=&gt;s.milesFromStart&gt;posMiles)?.milesFromStart||totalMiles) + reserve - (posMiles+curRange))/mpgEff;</p>
<p class="p1"><span class="Apple-converted-space">            </span>plan.push({type:'gap', action:`Insufficient range window; increase starting fuel by ${needMore.toFixed(1)} gal or reduce reserve.`});</p>
<p class="p1"><span class="Apple-converted-space">            </span>break;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>const milesTo = target.milesFromStart - posMiles;</p>
<p class="p1"><span class="Apple-converted-space">          </span>fuelGal = Math.max(0, fuelGal - milesTo/mpgEff);</p>
<p class="p1"><span class="Apple-converted-space">          </span>posMiles = target.milesFromStart;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>const nextCheaper = withMiles.find(s=&gt; s.milesFromStart&gt;posMiles &amp;&amp; (s.dieselPrice??Infinity) &lt; (target.dieselPrice??Infinity) &amp;&amp; (s.milesFromStart - posMiles) &lt;= maxRange - reserve);</p>
<p class="p1"><span class="Apple-converted-space">          </span>let buyGal;</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(nextCheaper){</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needMiles = nextCheaper.milesFromStart - posMiles + reserve;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needGal = Math.max(0, needMiles/mpgEff - fuelGal);</p>
<p class="p1"><span class="Apple-converted-space">            </span>buyGal = Math.min( tank - fuelGal, needGal );</p>
<p class="p1"><span class="Apple-converted-space">          </span>}else{</p>
<p class="p1"><span class="Apple-converted-space">            </span>const remMiles = totalMiles - posMiles + reserve;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const needGal = Math.max(0, remMiles/mpgEff - fuelGal);</p>
<p class="p1"><span class="Apple-converted-space">            </span>buyGal = Math.min( tank - fuelGal, needGal );</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>const estPrice = target.dieselPrice ?? null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>const estCost = estPrice!=null ? buyGal*estPrice : null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>plan.push({type:'stop', station:target, gallons:buyGal, cost:estCost});</p>
<p class="p1"><span class="Apple-converted-space">          </span>fuelGal += buyGal;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>return {plan, mpgEff, maxRange, totalMiles};</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>function renderPlan(out){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const box=$('recoPlan'); box.innerHTML='';</p>
<p class="p1"><span class="Apple-converted-space">        </span>const sum=$('recoSummary');</p>
<p class="p1"><span class="Apple-converted-space">        </span>sum.innerHTML = `&lt;div class="kvs"&gt;&lt;div&gt;Effective MPG&lt;/div&gt;&lt;div class="mono"&gt;${out.mpgEff.toFixed(2)}&lt;/div&gt;&lt;div&gt;Max range (full tank)&lt;/div&gt;&lt;div class="mono"&gt;${out.maxRange.toFixed(0)} mi&lt;/div&gt;&lt;div&gt;Total route&lt;/div&gt;&lt;div class="mono"&gt;${out.totalMiles.toFixed(0)} mi&lt;/div&gt;&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(out.plan.length===0){ box.innerHTML='&lt;div class="muted"&gt;No actions needed.&lt;/div&gt;'; return; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>out.plan.forEach(step=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">          </span>const row=document.createElement('div'); row.className='station';</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(step.type==='stop'){</p>
<p class="p1"><span class="Apple-converted-space">            </span>row.innerHTML=`&lt;div&gt;&lt;b&gt;Stop at:&lt;/b&gt; ${step.station.name} &lt;span class="muted"&gt;(${step.station.addr||'coords'})&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">              </span>&lt;div&gt;Buy &lt;b&gt;${step.gallons.toFixed(1)} gal&lt;/b&gt;${step.cost!=null?` @ ~$${(step.station.dieselPrice).toFixed(3)}/gal ≈ &lt;b&gt;$${step.cost.toFixed(2)}&lt;/b&gt;`:''}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">              </span>&lt;div class="muted"&gt;Milepost: ${step.station.milesFromStart.toFixed(1)} · Price source: ${step.station.dieselPrice_note||'—'}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}else{</p>
<p class="p1"><span class="Apple-converted-space">            </span>row.innerHTML=`&lt;div&gt;${step.action}&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>box.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Render stations ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>function renderStations(routeGeo, stations){</p>
<p class="p1"><span class="Apple-converted-space">        </span>const sort = $('sortBy').value;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const coords=routeGeo.coordinates;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const annotated = stations.map(s=&gt;{ const idx=nearestIndexOnRoute({lat:s.lat,lon:s.lon},coords); const milesFromStart=pathDist(coords,0,idx)*MI_PER_M; return {...s, idx, milesFromStart}; });</p>
<p class="p1"><span class="Apple-converted-space">        </span>let items = annotated;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(sort==='distance') items = annotated.slice().sort((a,b)=&gt;a.milesFromStart-b.milesFromStart);</p>
<p class="p1"><span class="Apple-converted-space">        </span>else if(sort==='price') items = annotated.slice().sort((a,b)=&gt; (a.dieselPrice??Infinity)-(b.dieselPrice??Infinity));</p>
<p class="p1"><span class="Apple-converted-space">        </span>else items = annotated.slice().sort((a,b)=&gt;a.idx-b.idx);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">        </span>const host=$('stations'); host.innerHTML='';</p>
<p class="p1"><span class="Apple-converted-space">        </span>if(items.length===0){ host.innerHTML='&lt;div class="muted"&gt;No stations found within your detour/filters for this route. Try widening detour or allowing all chains.&lt;/div&gt;'; return; }</p>
<p class="p1"><span class="Apple-converted-space">        </span>items.forEach(s=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">          </span>const maps=`https://www.google.com/maps/search/?api=1&amp;query=${s.lat},${s.lon}`;</p>
<p class="p1"><span class="Apple-converted-space">          </span>const priceStr = s.dieselPrice!=null? `$${s.dieselPrice.toFixed(3)}/gal` : '—';</p>
<p class="p1"><span class="Apple-converted-space">          </span>const note = s.dieselPrice_note? ` &lt;span class="muted"&gt;(${s.dieselPrice_note})&lt;/span&gt;`:'';</p>
<p class="p1"><span class="Apple-converted-space">          </span>const major=['Pilot','Flying J','Love\'s','TA','Petro','TA Express','Sapp Bros','Kwik Trip','Kwik Star','Maverik'];</p>
<p class="p1"><span class="Apple-converted-space">          </span>const chainType=major.some(m=&gt;(s.brand||'').toLowerCase().includes(m.toLowerCase()))?'Major':'Independent';</p>
<p class="p1"><span class="Apple-converted-space">          </span>const row=document.createElement('div'); row.className='station';</p>
<p class="p1"><span class="Apple-converted-space">          </span>row.innerHTML=`&lt;div&gt;&lt;b&gt;${s.name}&lt;/b&gt;&lt;div class="muted"&gt;${s.addr||''}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div style="margin-top:4px"&gt;Brand: &lt;span class="badge"&gt;${s.brand||'—'}&lt;/span&gt; · Chain: &lt;span class="badge"&gt;${chainType}&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div style="margin-top:4px"&gt;Diesel: &lt;b&gt;${priceStr}&lt;/b&gt;${note}&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div style="margin-top:4px"&gt;Distance from start: &lt;b&gt;${s.milesFromStart.toFixed(1)} mi&lt;/b&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">            </span>&lt;div style="margin-top:4px"&gt;&lt;a href="${maps}" target="_blank"&gt;Open in Maps&lt;/a&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;/div&gt;`;</p>
<p class="p1"><span class="Apple-converted-space">          </span>host.appendChild(row);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Plan handler ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>async function plan(){</p>
<p class="p1"><span class="Apple-converted-space">        </span>try{</p>
<p class="p1"><span class="Apple-converted-space">          </span>$('loading').style.display='flex';</p>
<p class="p1"><span class="Apple-converted-space">          </span>note('','');</p>
<p class="p1"><span class="Apple-converted-space">          </span>const startQ=$('start').value.trim(); const endQ=$('end').value.trim();</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(!startQ||!endQ){ note('error','Please enter both &lt;b&gt;Start&lt;/b&gt; and &lt;b&gt;Destination&lt;/b&gt;.'); return; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>const [a,b]=await Promise.all([geocode(startQ), geocode(endQ)]);</p>
<p class="p1"><span class="Apple-converted-space">          </span>let geo=null;</p>
<p class="p1"><span class="Apple-converted-space">          </span>try { geo = await routeGeoapify(a,b); } catch(_) { geo = await routeOSRM(a,b); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>const detour = readDetour();</p>
<p class="p1"><span class="Apple-converted-space">          </span>const chain<span class="Apple-converted-space">  </span>= $('chainFilter').value;</p>
<p class="p1"><span class="Apple-converted-space">          </span>const provider = $('provider').value;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>let stns = await fetchStationsGeoapify(geo, detour, chain);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if(provider==='eia'){</p>
<p class="p1"><span class="Apple-converted-space">            </span>try{ stns = await enrichWithEIA(stns); }catch(e){ /* Make sure we never show blanks */ stns.forEach(s=&gt;{ if(s.dieselPrice==null){ s.dieselPrice=3.95; s.dieselPrice_note='EIA U.S. avg. (fallback)'; } }); }</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>renderStations(geo, stns);</p>
<p class="p1"><span class="Apple-converted-space">          </span>note('ok','Route and stations loaded.');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">          </span>$('recoBtn').onclick=()=&gt;{ const out=aiRecommend(geo, stns); renderPlan(out); };</p>
<p class="p1"><span class="Apple-converted-space">        </span>}catch(e){</p>
<p class="p1"><span class="Apple-converted-space">          </span>note('error', e.message);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}finally{</p>
<p class="p1"><span class="Apple-converted-space">          </span>$('loading').style.display='none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">      </span>// --- Wire up UI ---</p>
<p class="p1"><span class="Apple-converted-space">      </span>$('planBtn').onclick=async()=&gt;{ const btn=$('planBtn'); btn.disabled=true; btn.textContent='Planning…'; try{ await plan(); } finally { btn.disabled=false; btn.textContent='Plan Route'; } };</p>
<p class="p1"><span class="Apple-converted-space">      </span>$('resetBtn').onclick=()=&gt;location.reload();</p>
<p class="p1"><span class="Apple-converted-space">      </span>$('sortBy').onchange=plan; $('chainFilter').onchange=plan; $('provider').onchange=plan;</p>
<p class="p1"><span class="Apple-converted-space">      </span>attachAutocomplete('start','startList'); attachAutocomplete('end','endList');</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
